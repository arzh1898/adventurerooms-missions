<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Missions</title>

  <style>
    :root {
      --red: #e30613;
      --black: #111;
      --white: #fff;
      --grey: #333;
      --lightgrey: #eee;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--black);
      color: var(--lightgrey);
    }

    header {
      background: var(--red);
      padding: 8px 10px;
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #headerLeft {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
      font-size: 18px;
    }

    #headerLeft img {
      height: 32px;
      width: auto;
    }

    #headerRight {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #headerRight select,
    #headerRight button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      cursor: pointer;
      font-weight: bold;
    }

    #headerRight select {
      background: #fff;
      color: #000;
    }

    #headerRight button {
      background: transparent;
      border: 1px solid #fff;
      color: #fff;
    }

    #headerRight button:hover {
      background: rgba(255,255,255,0.15);
    }

    #joinScreen, #mainScreen {
      padding: 16px;
    }
    #mainScreen { display: none; }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 12px;
      background: var(--grey);
      color: var(--white);
      font-size: 16px;
    }

    button.mainBtn {
      width: 100%;
      padding: 12px;
      background: var(--red);
      color: var(--white);
      border-radius: 8px;
      border: none;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
      cursor: pointer;
    }

    .mission-card {
      background: #1b1b1b;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .mission-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .mission-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--white);
    }
    .mission-subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-top: -2px;
    }
    .mission-desc {
      margin: 10px 0;
      font-size: 14px;
      line-height: 1.4;
    }
    .symbols {
      font-size: 24px;
      min-width: 40px;
      text-align: right;
    }

    .mission-status-label {
      font-size: 12px;
      margin-top: 6px;
    }
    .mission-status-pending {
      color: #ffcc66;
    }
    .mission-status-approved {
      color: #4ade80;
      font-weight: bold;
    }
    .mission-status-rejected {
      color: #ef4444;
      font-weight: bold;
    }
    #legendBox {
      background: #1b1b1b;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .status {
      font-size: 13px;
      margin-left: 4px;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #ef4444; }

    /* Chat */
    #chatBox {
      margin-top: 20px;
      background: #1b1b1b;
      padding: 12px;
      border-radius: 10px;
    }
    #chatMessages {
      background: #000;
      padding: 10px;
      min-height: 120px;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .chat-line {
      margin-bottom: 6px;
    }
    .chat-line .sender {
      font-weight: bold;
      color: #ffd166;
      margin-right: 4px;
    }

    /* Overlays */
    #broadcastOverlay,
    #gmMsgOverlay,
    #rulesOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #broadcastOverlay.active,
    #gmMsgOverlay.active,
    #rulesOverlay.active {
      display: flex;
    }

    .overlayBox {
      background: var(--white);
      color: var(--black);
      max-width: 480px;
      width: 90%;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .overlayBox h3 {
      margin-top: 0;
    }

    .overlayBox button {
      width: auto;
      margin-top: 10px;
      padding: 8px 18px;
      background: var(--red);
      color: #fff;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    /* Timer */
    #timerArea {
      background: #222;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
	}
	@media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      #headerLeft {
        width: 100%;
        justify-content: space-between;
      }

      #headerLeft span {
        font-size: 16px;
      }

      #headerRight {
        width: 100%;
        justify-content: flex-start;
      }

      .mission-card {
        padding: 12px;
      }

      .mission-title {
        font-size: 16px;
      }

      .mission-desc {
        font-size: 13px;
      }

      button.mainBtn {
        font-size: 14px;
        padding: 10px;
      }

      #chatBox {
        margin-bottom: 80px; /* etwas Luft unten */
      }
    }
 
  

  </style>
</head>

<body>

<header>
  <div id="headerLeft">
    <!-- Logo-Datei bei Bedarf anpassen -->
    <img src="/ARlogo.jpg" alt="AdventureRooms Logo">
    <span>AdventureRooms Missions</span>
  </div>
  <div id="headerRight">
    <select id="langSelect">
      <option value="de">Deutsch</option>
      <option value="en">English</option>
    </select>
    <button id="rulesBtn">Regeln</button>
  </div>
</header>

<!-- JOIN SCREEN -->
<div id="joinScreen">
  <h2 id="welcomeTitle">Willkommen bei AR Missions</h2>

  <label for="teamName" id="teamNameLabel">Teamname</label>
  <input type="text" id="teamName" placeholder="Teamname eingeben">

  <button class="mainBtn" id="joinBtn">Starten</button>
</div>

<!-- MAIN SCREEN -->
<div id="mainScreen">

  <div id="timerArea">75:00</div>
<div id="teamBanner" style="margin:-10px 0 14px 0; font-size:14px; opacity:0.9;">
  Team: <strong id="teamBannerName">‚Äî</strong>
</div>


  <h2 id="missionsTitle">Missionen</h2>

<div id="legendBox">
  <strong>Legende / Legend</strong><br>
  üè† Mission darf auch in einem Geb√§ude gemacht werden / Mission may also be done indoors<br>
  üì∑ Foto-Mission / Photo mission<br>
  üé• Video-Mission / Video mission
</div>

<div id="missionsContainer"></div>


  <!-- Extra Challenge -->
  <div class="mission-card">
    <div class="mission-header">
      <div>
        <div class="mission-title" id="extraTitle">EXTRA CHALLENGE</div>
        <div class="mission-subtitle">Bonus</div>
        <div id="extraStatus" class="mission-status-label"></div>
      </div>
      <div class="symbols">‚≠ê</div>
    </div>
    <div class="mission-desc" id="extraDesc">
      Jedes Team soll das teuerste Gericht einer Speisekarte finden.
      Wenn es teurer ist als bei den anderen Teams ‚Üí Sieg!
    </div>
    <form id="extraForm">
      <input type="file" id="extraFile" accept="image/*,video/*" required>
      <button type="submit">Upload</button>
      <span id="extraUploadMsg" class="status"></span>
    </form>
  </div>

  <!-- Chat -->
  <div id="chatBox">
    <h3 id="chatTitle">Chat</h3>
    <div id="chatMessages"></div>
    <input type="text" id="chatInput" placeholder="Nachricht eingeben...">
    <button class="mainBtn" id="chatSendBtn">Senden</button>
  </div>
</div>

<!-- Broadcast popup -->
<div id="broadcastOverlay">
  <div class="overlayBox">
    <h3 id="broadcastTitle">Nachricht des Game Masters</h3>
    <p id="broadcastText"></p>
    <button id="broadcastOkBtn">OK</button>
  </div>
</div>

<!-- GM rejection popup -->
<div id="gmMsgOverlay">
  <div class="overlayBox">
    <h3 id="gmMsgTitle">Nachricht vom Game Master</h3>
    <p id="gmMsgText"></p>
    <button id="gmMsgOkBtn">OK</button>
  </div>
</div>

<!-- Regeln popup -->
<div id="rulesOverlay">
  <div class="overlayBox">
    <h3 id="rulesTitle">Regeln</h3>
    <div id="rulesBody"></div>
    <button id="rulesCloseBtn">OK</button>
  </div>
</div>

<script>
let currentLang = "de";
let currentTeamId = null;
let currentTeamName = "";
let missionStatusInterval = null;
let chatInterval = null;
let broadcastInterval = null;
let timerInterval = null;
let lastSeenChatId = 0;
let extraMissionId = 21;

const i18n = {
  de: {
    welcomeTitle: "Willkommen bei AdventureRooms Missions",
    teamNameLabel: "Teamname",
    teamNamePlaceholder: "Teamname eingeben",
    rulesButton: "Regeln",
    joinBtn: "Starten",
    missions: "Missionen",
    chat: "Chat",
    uploadOk: "Upload erfolgreich",
    uploadErr: "Upload fehlgeschlagen",
    chatSend: "Senden",
    chatInputPlaceholder: "Nachricht eingeben...",
    extraDesc:
     "Jedes Team soll das teuerste Gericht einer Speisekarte finden. Ist dieses teurer als jenes der anderen Teams, gewinnt dieses Team die Extra Challenge.",
	missionStatus: {
      pending: "‚è≥ Eingereicht (wartet auf Pr√ºfung)",
      approved: "‚úÖ Erf√ºllt",
      rejected: "‚úñ Nicht akzeptiert"
    },
    rulesTitle: "Spielregeln",
    rulesHtml: `
      <ul style="text-align:left; padding-left:18px; font-size:14px;">
        <li>Ihr habt insgesamt <strong>75 Minuten</strong> Zeit f√ºr alle Missionen.</li>
        <li>Ihr m√ºsst sp√§testens nach Ablauf der 75 Minuten wieder am vereinbarten Startpunkt sein.</li>
        <li>Die Missionen werden grunds√§tzlich draussen durchgef√ºhrt.
            <br><strong>Ausnahme:</strong> Missionen mit dem Haussymbol üè† d√ºrft ihr auch in einem Geb√§ude machen.</li>
        <li>Auf jedem Foto/Video m√ºssen mindestens so viele Personen zu sehen sein wie <strong>Teilnehmerzahl minus 1</strong>.
            <br><em>Beispiel:</em> Wenn ihr ein 4er-Team seid, m√ºssen mindestens 3 Personen auf dem Foto/Video sichtbar sein.</li>
        <li>Ihr d√ºrft die Missionen in beliebiger Reihenfolge l√∂sen.</li>
        <li>Wenn eine Mission abgelehnt wird, seht ihr den Grund in einer Nachricht vom Game Master.</li>
        <li>Der Game Master kann euch jederzeit Nachrichten schicken ‚Äì diese erscheinen als Pop-up und m√ºssen mit <strong>OK</strong> best√§tigt werden.</li>
      </ul>
    `
  },
  en: {
    welcomeTitle: "Welcome to AdventureRooms Missions",
    teamNameLabel: "Team name",
    teamNamePlaceholder: "Enter team name",
    joinBtn: "Start",
    missions: "Missions",
    rulesButton: "Rules",
    chat: "Chat",
    uploadOk: "Upload successful",
    uploadErr: "Upload failed",
    chatSend: "Send",
    chatInputPlaceholder: "Type a message...",
    extraDesc:
      "Each team has to find the most expensive dish on a menu. If it is more expensive than the others you get an extra point!",
    missionStatus: {
      pending: "‚è≥ Submitted (waiting for review)",
      approved: "‚úÖ Completed",
      rejected: "‚úñ Not accepted"
    },
    rulesTitle: "Game rules",
    rulesHtml: `
      <ul style="text-align:left; padding-left:18px; font-size:14px;">
        <li>You have <strong>75 minutes</strong> to complete all missions.</li>
        <li>You must be back at the agreed starting point before the 75 minutes are over.</li>
        <li>Most missions must be done outdoors.
            <br><strong>Exception:</strong> missions with the house icon üè† may be done indoors.</li>
        <li>Each photo/video must show at least <strong>team size minus 1</strong> members.
            <br><em>Example:</em> If your team has 4 people, at least 3 must be visible in the photo/video.</li>
        <li>You may complete the missions in any order.</li>
        <li>If a mission is rejected, you will see the reason in a message from the Game Master.</li>
        <li>The Game Master can send you messages at any time ‚Äì they appear as a pop-up and must be confirmed with <strong>OK</strong>.</li>
      </ul>
    `
  }
};

function applyLang() {
  const t = i18n[currentLang];
  document.getElementById("welcomeTitle").textContent = t.welcomeTitle;
  document.getElementById("missionsTitle").textContent = t.missions;
  document.getElementById("chatTitle").textContent = t.chat;
  document.getElementById("extraDesc").textContent = t.extraDesc;
  document.getElementById("teamNameLabel").textContent = t.teamNameLabel;
  document.getElementById("teamName").placeholder = t.teamNamePlaceholder;
  document.getElementById("joinBtn").textContent = t.joinBtn;
  document.getElementById("chatInput").placeholder = t.chatInputPlaceholder;
  document.getElementById("chatSendBtn").textContent = t.chatSend;
  document.getElementById("rulesBtn").textContent = t.rulesButton;
}

document.getElementById("langSelect").onchange = (e) => {
  currentLang = e.target.value;
  applyLang();
  // Missionskarten neu in der gew√§hlten Sprache aufbauen
  if (currentTeamId) {
    loadMissions();
    loadMissionStatus();
  }
};

document.getElementById("rulesBtn").onclick = () => {
  const t = i18n[currentLang];
  document.getElementById("rulesTitle").textContent = t.rulesTitle;
  document.getElementById("rulesBody").innerHTML = t.rulesHtml;
  document.getElementById("rulesOverlay").classList.add("active");
};

document.getElementById("rulesCloseBtn").onclick = () => {
  document.getElementById("rulesOverlay").classList.remove("active");
};

document.getElementById("rulesOverlay").addEventListener("click", (e) => {
  if (e.target.id === "rulesOverlay") {
    document.getElementById("rulesOverlay").classList.remove("active");
  }
});

// JOIN
document.getElementById("joinBtn").onclick = async () => {
  const name = document.getElementById("teamName").value.trim();
  if (!name) return;

  const r = await fetch("/api/join", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ teamName: name })
  });

  const j = await r.json();

  if (!r.ok) {
    alert("Fehler beim Join.");
    return;
  }

  currentTeamId = j.teamId;
currentTeamName = name;
const bn = document.getElementById("teamBannerName");
if (bn) bn.textContent = currentTeamName;


  document.getElementById("joinScreen").style.display = "none";
  document.getElementById("mainScreen").style.display = "block";

  loadMissions();
  startTimerPolling();
  startMissionStatusPolling();
  startChatPolling();
  startBroadcastPolling();
  applyLang();
};

// LOAD MISSIONS
async function loadMissions() {
  const res = await fetch("/api/missions");
  const missions = await res.json();

  const cont = document.getElementById("missionsContainer");
  cont.innerHTML = "";

  missions.forEach(m => {
    if (m.number === 21) return; // Extra Challenge separat

    const title = currentLang === "de" ? m.title_de : m.title_en;
    const desc = currentLang === "de" ? m.description_de : m.description_en;

        // Kamera-Typ bestimmen (Foto oder Video)
    let camIcon = "üì∑"; // Standard: Foto
    const videoMissions = [11, 12, 13, 15, 17]; // hier sind Video-Missionen
    if (videoMissions.includes(m.number)) {
      camIcon = "üé•";
    }

    // Haus-Symbol f√ºr Missionen, die auch drinnen erlaubt sind
    const indoorMissions = [3, 6, 8, 9, 10, 12, 16];
    const hasHouse = indoorMissions.includes(m.number);

    // Endg√ºltige Icon-Kombination
    let icons = hasHouse ? `üè† ${camIcon}` : camIcon;

    const div = document.createElement("div");
    div.className = "mission-card";
    div.innerHTML = `
      <div class="mission-header">
        <div>
          <div class="mission-title">M${m.number}: ${title}</div>
          <div class="mission-subtitle"></div>
          <div class="mission-status-label" data-mission-id="${m.id}"></div>
        </div>
        <div class="symbols">${icons}</div>
      </div>

      <div class="mission-desc">${desc}</div>

      <form class="mission-form" data-mission-id="${m.id}">
        <input type="file" accept="image/*,video/*" required>
        <button type="submit" class="mainBtn">Upload</button>
        <span class="status"></span>
      </form>
    `;

    cont.appendChild(div);

    div.querySelector("form").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const formElem = ev.target;
      const fileInput = formElem.querySelector("input[type=file]");
      const file = fileInput.files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append("media", file);
      fd.append("teamId", currentTeamId);
      fd.append("missionId", m.id);

      const t = i18n[currentLang];

      const resp = await fetch("/api/submissions", { method: "POST", body: fd });
      const statusSpan = formElem.querySelector(".status");
      if (resp.ok) {
        statusSpan.textContent = t.uploadOk;
        statusSpan.className = "status ok";
        fileInput.value = "";
        loadMissionStatus();
      } else {
        statusSpan.textContent = t.uploadErr;
        statusSpan.className = "status err";
      }
    });
  });
}

// EXTRA CHALLENGE
document.getElementById("extraForm").onsubmit = async (ev) => {
  ev.preventDefault();
  const file = document.getElementById("extraFile").files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("media", file);
  fd.append("teamId", currentTeamId);
  fd.append("missionId", extraMissionId);

  const t = i18n[currentLang];
  const msg = document.getElementById("extraUploadMsg");

  const r = await fetch("/api/submissions", { method: "POST", body: fd });
  if (r.ok) {
    msg.textContent = t.uploadOk;
    msg.className = "status ok";
    document.getElementById("extraFile").value = "";
    loadMissionStatus();
  } else {
    msg.textContent = t.uploadErr;
    msg.className = "status err";
  }
};

// MISSION STATUS
async function loadMissionStatus() {
  if (!currentTeamId) return;

  const t = i18n[currentLang];
  const r = await fetch("/api/team/mission-status?teamId=" + currentTeamId);
  if (!r.ok) return;
  const data = await r.json();

  document.querySelectorAll(".mission-status-label").forEach(l => {
    l.textContent = "";
    l.className = "mission-status-label";
  });

  data.forEach(row => {
    const label = document.querySelector(`.mission-status-label[data-mission-id="${row.missionId}"]`);
    if (!label) return;

    if (row.status === "approved") {
      label.textContent = t.missionStatus.approved;
      label.classList.add("mission-status-approved");
    } else if (row.status === "rejected") {
      label.textContent = t.missionStatus.rejected;
      label.classList.add("mission-status-rejected");
    } else {
      label.textContent = t.missionStatus.pending;
      label.classList.add("mission-status-pending");
    }

    if (row.missionId === extraMissionId) {
      const s = document.getElementById("extraStatus");
      s.textContent = label.textContent;
      s.className = label.className;
    }
  });
}

function startMissionStatusPolling() {
  loadMissionStatus();
  if (missionStatusInterval) clearInterval(missionStatusInterval);
  missionStatusInterval = setInterval(loadMissionStatus, 8000);
}

// TIMER
async function loadTimer() {
  const res = await fetch("/api/timer");
  const j = await res.json();

  const box = document.getElementById("timerArea");

  if (!j.running) {
    box.textContent = "75:00";
    return;
  }

  let sec = j.remainingSeconds;
  let m = Math.floor(sec / 60);
  let s = sec % 60;
  if (s < 10) s = "0" + s;
  box.textContent = `${m}:${s}`;
}

function startTimerPolling() {
  loadTimer();
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(loadTimer, 1000);
}

// CHAT
async function loadChat() {
  if (!currentTeamId) return;
  const r = await fetch("/api/team/messages?teamId=" + currentTeamId);
  const msgs = await r.json();

  const box = document.getElementById("chatMessages");
  box.innerHTML = "";

  let newGM = [];

  msgs.forEach(msg => {
    const line = document.createElement("div");
    line.className = "chat-line";
    const sender = msg.from_gm ? "GM" : "Team";
    line.innerHTML = `<span class="sender">${sender}:</span> ${msg.text}`;
    box.appendChild(line);

    if (msg.from_gm && msg.id > lastSeenChatId) {
      newGM.push(msg);
    }
  });

  if (msgs.length > 0) {
    lastSeenChatId = msgs[msgs.length - 1].id;
  }

  box.scrollTop = box.scrollHeight;

    if (newGM.length > 0) {
    const last = newGM[newGM.length - 1];

    // Sound abspielen
    const audio = document.getElementById("chatSound");
    if (audio) {
      try {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      } catch (e) {
        // falls Browser blockt ‚Äì einfach ignorieren
      }
    }

    // Popup anzeigen
    const overlay = document.getElementById("gmMsgOverlay");
    document.getElementById("gmMsgText").textContent = last.text;
    overlay.classList.add("active");
  }

  }

document.getElementById("gmMsgOkBtn").onclick = () => {
  document.getElementById("gmMsgOverlay").classList.remove("active");
};

function startChatPolling() {
  loadChat();
  if (chatInterval) clearInterval(chatInterval);
  chatInterval = setInterval(loadChat, 4000);
}

document.getElementById("chatSendBtn").onclick = async () => {
  const text = document.getElementById("chatInput").value.trim();
  if (!text) return;
  document.getElementById("chatInput").value = "";

  await fetch("/api/team/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ teamId: currentTeamId, text })
  });

  loadChat();
};

// BROADCAST
async function loadBroadcasts() {
  if (!currentTeamId) return;
  const r = await fetch("/api/team/broadcasts?teamId=" + currentTeamId);
  const arr = await r.json();

  if (arr.length === 0) return;

  const b = arr[0];

  const overlay = document.getElementById("broadcastOverlay");
  document.getElementById("broadcastText").textContent = b.text;
  overlay.classList.add("active");

  document.getElementById("broadcastOkBtn").onclick = async () => {
    overlay.classList.remove("active");
    await fetch("/api/team/broadcasts/ack", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ teamId: currentTeamId, broadcastId: b.id })
    });
  };
}

function startBroadcastPolling() {
  loadBroadcasts();
  if (broadcastInterval) clearInterval(broadcastInterval);
  broadcastInterval = setInterval(loadBroadcasts, 4000);
}

// initial
applyLang();
</script>

</body>
</html>





