<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>GM Panel ‚Äì AdventureRooms Missions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #111;
      color: #eee;
      padding: 0;
    }

    header {
      background: #e30613;
      padding: 16px;
      text-align: center;
      font-size: 22px;
      color: white;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }

    #loginBox {
      max-width: 320px;
      background: #222;
      padding: 20px;
      border-radius: 12px;
      margin: 50px auto;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    #mainPanel {
      padding: 16px;
      display: none;
    }

    input[type="password"], input[type="text"], textarea, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 12px;
      background: #333;
      color: white;
      box-sizing: border-box;
    }

    button {
      padding: 10px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin: 5px;
      font-weight: bold;
    }

    .btn-red   { background: #e30613; color: white; }
    .btn-grey  { background: #444; color: white; }
    .btn-green { background: #2fa34c; color: white; }
    .btn-blue  { background: #008cff; color: white; }

    h2 {
      border-bottom: 1px solid #444;
      padding-bottom: 4px;
      margin-top: 0;
    }

    .section {
      background: #1b1b1b;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    th, td {
      border-bottom: 1px solid #333;
      padding: 8px;
      vertical-align: top;
      text-align: left;
    }

    td img, td video {
      max-width: 220px;
      border-radius: 8px;
      display: block;
    }

    .gm-mission-desc {
      font-size: 12px;
      color: #ccc;
      margin-top: 4px;
      line-height: 1.35;
    }

    .chat-box {
      background: #111;
      padding: 10px;
      border-radius: 8px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
      border: 1px solid #2a2a2a;
    }

    .chat-line {
      margin-bottom: 6px;
      line-height: 1.35;
    }

    .chat-line b {
      color: #ffd166;
    }

    .commentInput {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 12px;
      box-sizing: border-box;
    }

    #timerStatus {
      font-size: 18px;
      margin: 0 0 10px 0;
      font-weight: bold;
      color: #ffd166;
    }

    @media (max-width: 700px) {
      td img, td video { max-width: 140px; }
    }

    /* Popup Overlay */
    #gmPopupOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 12px;
    }
    #gmPopupOverlay.active{ display:flex; }

    #gmPopupBox{
      background: #222;
      color: #fff;
      width: 100%;
      max-width: 520px;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    #gmPopupBox h3{ margin:0 0 6px 0; }
    #gmPopupBox p{ margin:0 0 10px 0; color:#ddd; }
    #gmPopupReply{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:none;
      background:#333;
      color:#fff;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
<header>GAME MASTER PANEL ‚Äì AdventureRooms Missions</header>

<div id="loginBox">
  <h3>GM Login</h3>
  <input type="password" id="password" placeholder="GM Passwort">
  <button class="btn-red" id="loginBtn">Login</button>
  <p id="loginStatus"></p>
</div>

<div id="mainPanel">

  <div class="section">
    <h2>‚è± TIMER</h2>
    <p id="timerStatus">Timer nicht gestartet.</p>
    <button class="btn-blue" id="timerStart">Start</button>
    <button class="btn-grey" id="timerStop">Stop</button>
  </div>

  <div class="section">
    <h2>üì¢ Nachricht an ALLE Teams</h2>
    <textarea id="broadcastText" rows="3" placeholder="Mitteilung an alle Teams..."></textarea>
    <button class="btn-blue" id="broadcastSend">Senden</button>
    <p id="broadcastStatus"></p>
  </div>

  <div class="section">
    <h2>üë• Teams & Rangliste (aktuelle Runde)</h2>
    <table id="teamTable">
      <thead>
        <tr><th>Team</th><th>Punkte</th><th>Aktion</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>üí¨ Team-Chat</h2>
    <select id="chatTeamSelect"></select>
    <div class="chat-box" id="chatMessages"></div>
    <input type="text" id="chatInput" placeholder="Nachricht an Team‚Ä¶">
    <button class="btn-blue" id="chatSend">Senden</button>
    <button class="btn-grey" id="chatReset">Chat dieses Teams l√∂schen</button>
    <p id="chatStatus"></p>
  </div>

  <div class="section">
    <h2>üì∑ Einsendungen</h2>
    <table id="submissionTable">
      <thead>
        <tr>
          <th>Team</th>
          <th>Mission</th>
          <th>Media</th>
          <th>Status</th>
          <th>Kommentar</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>‚ö† RESET</h2>
    <button class="btn-red" id="resetRound">‚ùå Ganze Runde resetten</button>
    <p>
      Achtung: L√∂scht <strong>alle Teams, Chats, Bilder/Videos & Timer</strong> dieser Runde.
      Die Missions bleiben bestehen.
    </p>
  </div>
</div>

<div id="gmPopupOverlay">
  <div id="gmPopupBox">
    <h3 id="gmPopupTitle">Neue Nachricht</h3>
    <p id="gmPopupText"></p>
    <input type="text" id="gmPopupReply" placeholder="Antwort schreiben‚Ä¶">
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn-blue" id="gmPopupSend">Antworten</button>
      <button class="btn-grey" id="gmPopupClose">Schliessen</button>
    </div>
  </div>
</div>

<script>
let GM_TOKEN = null;
let currentChatTeam = null;

let inboxInterval = null;
let lastSeenTeamMsgId = {};
let popupTeamId = null;

// Timer state
let gmTimerInterval = null;
let gmRemainingSeconds = null;

// render optimization
let lastSubmissionRenderKey = "";

// ---------- helpers ----------
function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
function escapeHtml(s){
  return safeStr(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function buildRenderKey(list){
  // simple key: newest id + count (good enough)
  if (!Array.isArray(list) || list.length === 0) return "empty";
  const first = list[0];
  return `${first.id}-${list.length}`;
}

// ---------------- LOGIN ----------------
document.getElementById("loginBtn").onclick = async () => {
  const pw = document.getElementById("password").value.trim();
  const res = await fetch("/api/gm/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: pw })
  });

  const data = await res.json().catch(() => ({}));
  if (!res.ok) {
    document.getElementById("loginStatus").textContent = "Falsches Passwort!";
    return;
  }

  GM_TOKEN = data.token;
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("mainPanel").style.display = "block";

  await loadAll();

  // ‚úÖ polling (not stacking)
  setInterval(loadAll, 8000);

  await loadInboxAndNotify();
  if (inboxInterval) clearInterval(inboxInterval);
  inboxInterval = setInterval(loadInboxAndNotify, 3000);

  await loadTimer();
  setInterval(loadTimer, 10000);
};

// ---------------- TIMER ----------------
function renderTimerStatus() {
  const box = document.getElementById("timerStatus");
  if (!box) return;

  if (gmRemainingSeconds === null) {
    box.textContent = "Timer nicht gestartet.";
    return;
  }

  const min = Math.floor(gmRemainingSeconds / 60);
  let sec = gmRemainingSeconds % 60;
  if (sec < 10) sec = "0" + sec;

  box.textContent = `Restzeit: ${min}:${sec}`;
}

async function loadTimer() {
  const res = await fetch("/api/timer");
  const data = await res.json().catch(() => ({ running:false }));

  if (!data.running) {
    gmRemainingSeconds = null;
    renderTimerStatus();

    if (gmTimerInterval) {
      clearInterval(gmTimerInterval);
      gmTimerInterval = null;
    }
    return;
  }

  gmRemainingSeconds = data.remainingSeconds;
  renderTimerStatus();

  if (!gmTimerInterval) {
    gmTimerInterval = setInterval(() => {
      if (gmRemainingSeconds === null) return;
      if (gmRemainingSeconds > 0) {
        gmRemainingSeconds--;
        renderTimerStatus();
      }
    }, 1000);
  }
}

document.getElementById("timerStart").onclick = async () => {
  await fetch("/api/gm/timer/start", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN }
  });
  loadTimer();
};

document.getElementById("timerStop").onclick = async () => {
  await fetch("/api/gm/timer/stop", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN }
  });

  gmRemainingSeconds = null;
  renderTimerStatus();

  if (gmTimerInterval) {
    clearInterval(gmTimerInterval);
    gmTimerInterval = null;
  }
  loadTimer();
};

// ---------------- BROADCAST ----------------
document.getElementById("broadcastSend").onclick = async () => {
  const text = document.getElementById("broadcastText").value.trim();
  if (!text) return;

  const res = await fetch("/api/gm/broadcast", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
    body: JSON.stringify({ text })
  });

  document.getElementById("broadcastStatus").textContent =
    res.ok ? "Gesendet!" : "Fehler beim Senden.";
  if (res.ok) document.getElementById("broadcastText").value = "";
};

// ---------------- TEAMS + RANGLISTE (SORTED) ----------------
async function loadTeamsAndRanking() {
  // ‚úÖ use scores as single source of truth (already sorted DESC by server)
  const scoreRes = await fetch("/api/gm/scores", { headers: { "x-gm-token": GM_TOKEN } });
  const scores = await scoreRes.json().catch(() => []);

  const tbody = document.querySelector("#teamTable tbody");
  tbody.innerHTML = "";

  scores.forEach(row => {
    const teamId = row.teamId;
    const teamName = escapeHtml(row.teamName);
    const points = row.points || 0;

    tbody.insertAdjacentHTML(
      "beforeend",
      `<tr>
        <td>${teamName}</td>
        <td>${points}</td>
        <td><button class="btn-blue" onclick="selectChatTeam(${teamId})">Chat</button></td>
      </tr>`
    );
  });

  // ‚úÖ keep selection stable
  const sel = document.getElementById("chatTeamSelect");
  const prev = currentChatTeam ? String(currentChatTeam) : null;

  sel.innerHTML = "";
  scores.forEach(r => {
    sel.insertAdjacentHTML("beforeend",
      `<option value="${r.teamId}">${escapeHtml(r.teamName)}</option>`
    );
  });

  // if previous selection still exists -> keep it
  const stillExists = prev && scores.some(r => String(r.teamId) === prev);
  if (stillExists) {
    currentChatTeam = prev;
    sel.value = prev;
  } else if (scores.length > 0) {
    currentChatTeam = String(scores[0].teamId);
    sel.value = currentChatTeam;
  } else {
    currentChatTeam = null;
  }
}

// ---------------- CHAT ----------------
function selectChatTeam(id) {
  currentChatTeam = String(id);
  const sel = document.getElementById("chatTeamSelect");
  if (sel) sel.value = currentChatTeam;
  loadChat();
}
window.selectChatTeam = selectChatTeam;

document.getElementById("chatTeamSelect").onchange = (e) => {
  currentChatTeam = String(e.target.value);
  loadChat();
};

async function loadChat() {
  if (!currentChatTeam) return;

  const res = await fetch(`/api/gm/messages?teamId=${currentChatTeam}`, {
    headers: { "x-gm-token": GM_TOKEN }
  });
  const msgs = await res.json().catch(() => []);

  const box = document.getElementById("chatMessages");
  box.innerHTML = "";

  msgs.forEach(m => {
    const sender = m.from_gm ? "GM" : "Team";
    box.insertAdjacentHTML(
      "beforeend",
      `<div class="chat-line"><b>${sender}:</b> ${escapeHtml(m.text)}</div>`
    );
  });

  box.scrollTop = box.scrollHeight;
}

document.getElementById("chatSend").onclick = async () => {
  if (!currentChatTeam) return;

  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if (!text) return;

  // simple anti-double-click
  document.getElementById("chatSend").disabled = true;

  const res = await fetch("/api/gm/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
    body: JSON.stringify({ teamId: Number(currentChatTeam), text })
  });

  document.getElementById("chatSend").disabled = false;

  if (res.ok) {
    input.value = "";
    document.getElementById("chatStatus").textContent = "";
    loadChat();
  } else {
    document.getElementById("chatStatus").textContent = "Fehler beim Senden.";
  }
};

document.getElementById("chatReset").onclick = async () => {
  if (!currentChatTeam) return;
  if (!confirm("Chat dieses Teams wirklich l√∂schen?")) return;

  await fetch("/api/gm/chat/reset-team", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
    body: JSON.stringify({ teamId: Number(currentChatTeam) })
  });

  loadChat();
};

// ---------------- INBOX POPUP ----------------
async function loadInboxAndNotify() {
  if (!GM_TOKEN) return;

  const res = await fetch("/api/gm/inbox", {
    headers: { "x-gm-token": GM_TOKEN }
  });
  if (!res.ok) return;

  const rows = await res.json().catch(() => []);

  rows.forEach(r => {
    if (!r.lastMessageId) return;
    const teamId = String(r.teamId);

    // nur Team->GM
    if (r.fromGm === 1) return;

    const prev = lastSeenTeamMsgId[teamId] || 0;
    if (r.lastMessageId > prev) {
      lastSeenTeamMsgId[teamId] = r.lastMessageId;
      showGmPopup(teamId, r.teamName, r.text);
    }
  });
}

function showGmPopup(teamId, teamName, text) {
  popupTeamId = String(teamId);
  document.getElementById("gmPopupTitle").textContent = `Neue Nachricht von ${teamName}`;
  document.getElementById("gmPopupText").textContent = safeStr(text);
  document.getElementById("gmPopupReply").value = "";
  document.getElementById("gmPopupOverlay").classList.add("active");

  selectChatTeam(teamId);
}

document.getElementById("gmPopupClose").onclick = () => {
  document.getElementById("gmPopupOverlay").classList.remove("active");
  popupTeamId = null;
};

document.getElementById("gmPopupSend").onclick = async () => {
  if (!popupTeamId) return;

  const input = document.getElementById("gmPopupReply");
  const text = input.value.trim();
  if (!text) return;

  document.getElementById("gmPopupSend").disabled = true;

  await fetch("/api/gm/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
    body: JSON.stringify({ teamId: Number(popupTeamId), text })
  });

  document.getElementById("gmPopupSend").disabled = false;

  document.getElementById("gmPopupOverlay").classList.remove("active");
  popupTeamId = null;

  loadChat();
};

// ---------------- SUBMISSIONS (stable video) ----------------
async function loadSubmissions() {
  const res = await fetch("/api/gm/submissions", {
    headers: { "x-gm-token": GM_TOKEN }
  });
  const list = await res.json().catch(() => []);

  // ‚úÖ re-render only when changed (prevents video restart / ‚Äúlag‚Äù)
  const key = buildRenderKey(list);
  if (key === lastSubmissionRenderKey) return;
  lastSubmissionRenderKey = key;

  const tbody = document.querySelector("#submissionTable tbody");
  tbody.innerHTML = "";

  list.forEach(s => {
    const isImg = s.mimetype && s.mimetype.startsWith("image");
    const cacheBust = `?v=${encodeURIComponent(s.id)}`;

    const media = isImg
      ? `<img src="/uploads/${encodeURIComponent(s.filename)}${cacheBust}" alt="upload">`
      : `<video
            src="/uploads/${encodeURIComponent(s.filename)}${cacheBust}"
            controls
            preload="metadata"
            playsinline
          ></video>`;

    tbody.insertAdjacentHTML(
      "beforeend",
      `<tr data-sub-id="${s.id}">
        <td>${escapeHtml(s.teamName)}</td>
        <td>
          <div><strong>M${s.missionNumber}: ${escapeHtml(s.missionTitleDe)}</strong></div>
          <div class="gm-mission-desc">${escapeHtml(s.missionDescDe || "")}</div>
        </td>
        <td>${media}</td>
        <td>${escapeHtml(s.status)}</td>
        <td>
          <input type="text" class="commentInput"
                 placeholder="Kommentar (Pflicht bei Ablehnen)"
                 value="${escapeHtml(s.comment || "")}">
        </td>
        <td>
          <button class="btn-green" onclick="review(${s.id}, 'approved', ${s.teamId}, 'M${s.missionNumber}')">‚úî</button>
          <button class="btn-red" onclick="review(${s.id}, 'rejected', ${s.teamId}, 'M${s.missionNumber}')">‚úñ</button>
        </td>
      </tr>`
    );
  });
}

async function review(id, status, teamId, missionLabel) {
  const row = document.querySelector(`tr[data-sub-id="${id}"]`);
  let comment = "";
  if (row) {
    const inp = row.querySelector(".commentInput");
    if (inp) comment = inp.value.trim();
  }

  if (status === "rejected" && !comment) {
    alert("Bitte Kommentar eingeben, warum die Mission abgelehnt wurde.");
    return;
  }

  await fetch(`/api/gm/submissions/${id}/review`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
    body: JSON.stringify({ status, comment })
  });

  if (status === "rejected" && teamId) {
    const text = `Mission ${missionLabel} wurde abgelehnt: ${comment}`;
    await fetch("/api/gm/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-gm-token": GM_TOKEN },
      body: JSON.stringify({ teamId, text })
    });
  }

  // force re-render submissions after review
  lastSubmissionRenderKey = "";
  loadSubmissions();
  loadTeamsAndRanking();
  if (teamId && String(currentChatTeam) === String(teamId)) loadChat();
}
window.review = review;

// ---------------- RESET ROUND ----------------
document.getElementById("resetRound").onclick = async () => {
  if (!confirm("Sicher? Ganze Runde wirklich zur√ºcksetzen?")) return;

  await fetch("/api/gm/reset", {
    method: "POST",
    headers: { "x-gm-token": GM_TOKEN }
  });

  currentChatTeam = null;
  document.getElementById("chatMessages").innerHTML = "";
  document.getElementById("chatTeamSelect").innerHTML = "";
  document.querySelector("#teamTable tbody").innerHTML = "";
  document.querySelector("#submissionTable tbody").innerHTML = "";

  gmRemainingSeconds = null;
  renderTimerStatus();
  if (gmTimerInterval) { clearInterval(gmTimerInterval); gmTimerInterval = null; }

  alert("Runde zur√ºckgesetzt!");

  lastSubmissionRenderKey = "";
  await loadAll();

  await loadInboxAndNotify();
  if (inboxInterval) clearInterval(inboxInterval);
  inboxInterval = setInterval(loadInboxAndNotify, 3000);
};

// ---------------- LOAD ALL ----------------
async function loadAll() {
  if (!GM_TOKEN) return;
  await loadTimer();
  await loadTeamsAndRanking();
  await loadSubmissions();
  await loadChat();
}
</script>
</body>
</html>
